<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:h="http://java.sun.com/jsf/html" 
	xmlns:f="http://java.sun.com/jsf/core" 
	xmlns:ui="http://java.sun.com/jsf/facelets" 
	xmlns:plc="http://www.powerlogic.com.br/plc" 
	xmlns:plcf="http://www.powerlogic.com.br/plcf" 
	xmlns:tr="http://myfaces.apache.org/trinidad" 
	xmlns:p="http://primefaces.org/ui"
	xmlns:trh="http://myfaces.apache.org/trinidad/html">  
	<ui:composition template="/fcls/template/PlcGeralTemplate.xhtml"> 
		<ui:define name="plc-corpo-formulario"> 
			<div id="plc-form-baco"> 
				<div id="#{plcAliasPrefixoAction}Arg" class="plc-form-basico-topo"> 
					<plcf:tabela tituloChave="mapaocorrenciasarg.titulo"> 										
						<plcf:linha> 
							<plcf:celula> 								
								<plcf:titulo value="#{msg['label.id']}"/>  
								<plcf:numerico id="id" value="#{mapaocorrencias.id}" ajudaChave="ajuda.id" tamanho="5"/> 								
							</plcf:celula>  
							<plcf:celula> 
								<plcf:titulo value="#{msg['label.tipoOcorrencia']}"/>  
								<plcf:comboDinamico id="tipoOcorrencia" value="#{mapaocorrencias.tipoOcorrencia}" dominio="TipoOcorrenciaEntity" exibeBranco="S" ajudaChave="ajuda.tipoOcorrencia"/> 								
							</plcf:celula>  
							<plcf:celula> 							
								<plcf:titulo value="#{msg['label.dataOcorrencia']}"/>  
								<plcf:data id="dataOcorrencia" value="#{mapaocorrencias.dataOcorrencia}" ajudaChave="ajuda.dataOcorrencia"/> 								
							</plcf:celula>  
							<plcf:celula> 								
								<plcf:titulo value="#{msg['label.dataConclusao']}"/>  
								<plcf:data id="dataConclusao" value="#{mapaocorrencias.dataConclusao}" ajudaChave="ajuda.dataConclusao"/> 								
							</plcf:celula>  
							<plcf:celula> 								
								<plcf:titulo value="#{msg['label.statusOcorrencia']}"/>  
								<plcf:comboEstatico id="statusOcorrencia" value="#{mapaocorrencias.statusOcorrencia}" dominio="StatusOcorrencia" exibeBranco="S" ajudaChave="ajuda.statusOcorrencia"/> 								
							</plcf:celula> 

							<plcf:celula> 								
									<plcf:titulo value="#{msg['label.protocolo']}"/>  
									<plcf:texto id="protocolo" value="#{mapaocorrencias.protocolo}" tamanho="20" tamanhoMaximo="100" ajudaChave="ajuda.protocolo"/> 								
							</plcf:celula> 

							<plcf:celula > 								
								<plcf:titulo value="#{msg['label.endereco']}"/>  
								<plcf:texto id="endereco" value="#{mapaocorrencias.endereco}" tamanho="60" tamanhoMaximo="100" ajudaChave="ajuda.endereco"/> 								
							</plcf:celula> 

						</plcf:linha>
						

	

						<!--	<plcf:celula> 
								<plcf:titulo value="Listagem de Ocorrências"/>  							
        						<plcf:caixaMarcacao id="listagemOcorrencia" value="#{plcAction.listagemOcorrencia}" onclick="visualizaListagem()" />		
        					</plcf:celula>				-->

						
					</plcf:tabela> 
					 
					
					<div id="#{plcAliasPrefixoAction}Sel" class="_plc-form-basico-sel"> 
					<fieldset class="plc-fieldset"> 
						<legend class="plc-fieldset-legend">Resultados</legend>  
						<plcf:iteracao var="item" value="#{mapaocorrenciasLista.itensPlc}" styleClass="plc-table-tabsel delimitador tabelaFormulario plc-table-seljsf" columnClasses="celulaFormulario" headerClass="celulaFormulario"> 
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.id']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.id}" classeCSS="idItem">id</plcf:exibe> 
							</h:column>  
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.tipoOcorrencia']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.tipoOcorrencia}">tipoOcorrencia</plcf:exibe> 
							</h:column>  
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.dataOcorrencia']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.dataOcorrencia}">dataOcorrencia</plcf:exibe> 
							</h:column>  
						
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.statusOcorrencia']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.statusOcorrencia}">statusOcorrencia</plcf:exibe> 
							</h:column>  
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.protocolo']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.protocolo}">protocolo</plcf:exibe> 
							</h:column>  

							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.pessoa']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.pessoa}">pessoa</plcf:exibe> 
							</h:column>
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.endereco']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.endereco}">endereco</plcf:exibe> 
							</h:column> 							  
							 
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.dataConclusao']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.dataConclusao}">dataConclusao</plcf:exibe> 
							</h:column>  

							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.responsavelConclusao']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.responsavelConclusao}">responsavelConclusao</plcf:exibe> 
							</h:column> 
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.latitude']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.latitude}">latitude</plcf:exibe> 
							</h:column> 
							<h:column> 
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.longitude']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.longitude}">longitude</plcf:exibe> 
							</h:column> 
							<h:column> 	
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="#{msg['label.observacao']}"/> 
									</span> 
								</f:facet>  
								<plcf:exibe value="#{item.observacao}">observacao</plcf:exibe> 
							</h:column>		
							<h:column> 	
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="Foto"/> 
									</span> 
								</f:facet>  

								<img src='#{item.conteudoBinarioFoto}' height="115" width="83"/>								
							</h:column>	

							<h:column styleClass="escondido"> 	
								<f:facet name="header"> 
									<span class="plc-title af_outputLabel"> 
										<h:outputText value="FotoConteudo"/> 
									</span> 
								</f:facet>  

								<plcf:exibe value='#{item.conteudoBinarioFoto}'/>								
							</h:column>								


												
							
						</plcf:iteracao> 
					</fieldset>  
						<script>createLineSelection('#{request.contextPath}/f/n/ocorrenciaman');</script> 
					</div> 		
				</div>				

				<fieldset class="plc-fieldset plc-fieldset-embutido">
					<legend class="plc-fieldset-legend">Mapa de Ocorrências</legend>
					<plcf:tabela>
						<plcf:linha> 
							<plcf:celula columnSpan="5" inlineStyle="padding-left: 1%;">	
								<center>
									<div id="mapa" style="height: 500px; width: 1200px">
    								</div>
    							</center>
							</plcf:celula>
						</plcf:linha>
					</plcf:tabela> 
				</fieldset> 


			</div>
		<script type="text/javascript">//<![CDATA[

			var map;
			 
			function initialize() {				
			    var latlng = new google.maps.LatLng(#{plcAction.latitude}, #{plcAction.longitude});
			 
			    var options = {
			        zoom: 13,
			        center: latlng,
			        mapTypeId: google.maps.MapTypeId.ROADMAP
			    };
			 
			    map = new google.maps.Map(document.getElementById("mapa"), options);

			    colocarMarcadoresMapa();
			}
			 
			initialize();

			function colocarMarcadoresMapa(){
				var markers = [];				
			    var infowindow = new google.maps.InfoWindow();
			    var marker;
			    var conteudo = "";
			    var conteudoFoto;
			    var foto;			    
			    var listaOcorrencias = plc.jq('#corpo\\:formulario\\:item').tableToJSON();
			    //listaOcorrencias = JSON.stringify({ ocorrencia: listaOcorrencias });			    	
			    if (listaOcorrencias.length > 0) {   
			    	for (i = 0; i < listaOcorrencias.length; i++) {     
                                                                 		    				       
			            var ocorrencia = listaOcorrencias[i];

			    		var latlong = new google.maps.LatLng(ocorrencia.Latitude, ocorrencia.Longitude);	            

			            foto = ocorrencia.FotoConteudo;            
			            if (null != foto && foto.indexOf('image') > 0){    
			                conteudoFoto = '<img src="' + foto + '" height="115" width="83"/>';        
			            } else {
			                conteudoFoto = '<img src="#{request.contextPath}/res/midia/sem_imagem.jpg" height="115" width="83"/>';
			            }
			            
			            if (ocorrencia.Observação == null){
			                ocorrencia.Observação = "";
			            }

			            var urlEdita = window.location.origin;
			            
			            // Variável que define o conteúdo da Info Window
			            conteudo = '<div id="iw-container">' +
			                    '<div class="iw-title"> Tipo: ' + ocorrencia.Tipo + ' </div>' +
			                    '<div class="iw-content">' +
			                      '<div class="iw-subTitle">Descrição da Ocorrência</div>' +
			                      conteudoFoto +
			                      '<p><b>Data: </b>' + ocorrencia.Data + '<br/>' +
			                      '<b>Endereço: </b>' + ocorrencia.Endereço + '<br>' +
			                      '<b>Status: </b>' + ocorrencia.Status + '<br/>' +
			                      '<b>Observação: </b>' + ocorrencia.Observação + '<br/> </p>' +
			                      '<div class="iw-subTitle">Protocolo</div>' +
			                      '<p>'+ ocorrencia.Protocolo + '</p> <br/> <br/>'+
			                      '<p><a href="' + urlEdita + '#{request.contextPath}/f/n/ocorrenciaman?id=' +  ocorrencia.Cód + '" target="_blank">Visualizar</a></p>'+                      
			                    '</div>' +
			                    '<div class="iw-bottom-gradient"></div>' +
			                  '</div>';

			            var titulo = "Tipo: </b>" + ocorrencia.Tipo;

			            var icone;

			            if (ocorrencia.Status == "Em Aberto") {
			                icone = "http://maps.google.com/mapfiles/ms/micons/red-dot.png";                        
			            } else if (ocorrencia.Status == "Encaminhada") {
			                icone = "http://maps.google.com/mapfiles/ms/micons/blue-dot.png";                        
			            } else if (ocorrencia.Status == "Em Análise") {
			                icone = "http://maps.google.com/mapfiles/ms/micons/yellow-dot.png";                        
			            } else {
			                icone = "http://maps.google.com/mapfiles/ms/micons/green-dot.png";                        
			            }

			            marker = new google.maps.Marker({
			                position: latlong,
			                title: titulo,
			                map: map,
			                icon: icone
			            });
			            marker.html = conteudo;

			            var id = ocorrencia.Cód;
			            google.maps.event.addListener(marker, 'click', (function(marker, id) {
			                return function() {
			                  infowindow.setContent(this.html);
			                  infowindow.open(map, this);
			                }
			            })(marker, id));

			              // evento que fecha a infoWindow com click no mapa
			            google.maps.event.addListener(map, 'click', function() {
			                infowindow.close();
			            });

			            markers.push(marker);			            

			        google.maps.event.addListener(infowindow, 'domready', function() {
			  
			            // Referência ao DIV que agrupa o fundo da infowindow
			            var iwOuter = plc.jq('.gm-style-iw');

			            /* Uma vez que o div pretendido está numa posição anterior ao div .gm-style-iw.
			            * Recorremos ao jQuery e criamos uma variável iwBackground,
			            * e aproveitamos a referência já existente do .gm-style-iw para obter o div anterior com .prev().
			            */
			            var iwBackground = iwOuter.prev();

			            // Remover o div da sombra do fundo
			            iwBackground.children(':nth-child(2)').css({'display' : 'none'});

			            // Remover o div de fundo branco
			            iwBackground.children(':nth-child(4)').css({'display' : 'none'});

			            // Desloca a infowindow 115px para a direita
			            iwOuter.parent().parent().css({left: '115px'});

			            // Desloca a sombra da seta a 76px da margem esquerda 
			            iwBackground.children(':nth-child(1)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

			            // Desloca a seta a 76px da margem esquerda 
			            iwBackground.children(':nth-child(3)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

			            // Altera a cor desejada para a sombra da cauda
			            iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});

			            // Referência ao DIV que agrupa os elementos do botão fechar
			            var iwCloseBtn = iwOuter.next();

			            // Aplica o efeito desejado ao botão fechar
			            iwCloseBtn.css({opacity: '1', right: '38px', top: '3px', border: '7px solid #48b5e9', 'border-radius': '13px', 'box-shadow': '0 0 5px #3990B9'});

			            // Se o conteúdo da infowindow não ultrapassar a altura máxima definida, então o gradiente é removido.
			            if(plc.jq('.iw-content').height() < 140){
			              plc.jq('.iw-bottom-gradient').css({display: 'none'});
			            }

			            // A API aplica automaticamente 0.7 de opacidade ao botão após o evento mouseout. Esta função reverte esse evento para o valor desejado.
			            iwCloseBtn.mouseout(function(){
			              plc.jq(this).css({opacity: '1'});
			            });
			          });  
			        }

			        var markerCluster = new MarkerClusterer(map, markers,
            			{imagePath: '#{request.contextPath}/res/midia/m'});			        
			    }
			}			


	        function aposSelecaoModal(data) {
	            var status = data.status;
	            switch (status) {
	                case "success":
	                    var optsSel = {
	        				$tabela: plc.jq("table#"+prefixForm+'#{plcAliasPrefixoAction}')
	        				,urlEdicao:'#{request.contextPath}/f/n/ocorrenciaman'
	        				,numPorPagina: 50
	            			,propAgregada: 'mapaocorrencias'
	            			,nomePropAgregada: "nome"
	            			,paramEdicao: "id"
	        				,modoJanelaPlc:'${param.modoJanelaPlc}'
	                	}
						montarSelecaoSemGrid(optsSel);
	                break;
	            }
	        }

	        // Setup the statusUpdate function to hear all events on the page
	        jsf.ajax.addOnEvent(aposSelecaoModal);

	        function visualizaListagem(){
	        	if (plc.jq('#mapaocorrenciasSel').is(":visible") == true){
	        		plc.jq('#mapaocorrenciasSel').hide();	
	        	} else {
	        		plc.jq('#mapaocorrenciasSel').show();	
	        	}
	        }	

			plc.jq('#mapaocorrenciasSel').hide();	
			plc.jq('.escondido').hide();
	        plc.jq('#corpo\\:formulario\\:listagemOcorrencia').prop('checked', false);
        
		//]]> </script>  
			<div id="#{plcAliasPrefixoAction}Nav" class="plc-navegacao"> 
				<ui:include src="/WEB-INF/fcls-plc/geralPaginacaoLogicaItens.xhtml"/> 
			</div> 			
		</ui:define>
	</ui:composition> 
</html>
